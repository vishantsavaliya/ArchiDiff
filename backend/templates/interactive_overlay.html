<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Overlay Comparison</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #1a1a1a;
            color: #e0e0e0;
            overflow: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 300px;
            background: #252525;
            padding: 20px;
            overflow-y: auto;
            border-right: 1px solid #333;
        }

        .canvas-container {
            flex: 1;
            position: relative;
            overflow: hidden;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        canvas {
            display: block;
            cursor: grab;
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        canvas:active {
            cursor: grabbing;
        }

        h1 {
            font-size: 18px;
            margin-bottom: 20px;
            color: #4ade80;
        }

        .section {
            margin-bottom: 25px;
        }

        .section-title {
            font-size: 14px;
            color: #9ca3af;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .info-grid {
            display: grid;
            gap: 8px;
            font-size: 13px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            background: #1a1a1a;
            border-radius: 4px;
        }

        .info-label {
            color: #9ca3af;
        }

        .info-value {
            color: #e0e0e0;
            font-weight: 500;
        }

        .color-box {
            display: inline-block;
            width: 12px;
            height: 12px;
            margin-right: 6px;
            border-radius: 2px;
            vertical-align: middle;
        }

        .control-group {
            margin-bottom: 15px;
        }

        .control-label {
            display: block;
            font-size: 12px;
            color: #9ca3af;
            margin-bottom: 8px;
        }

        input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #1a1a1a;
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #4ade80;
            cursor: pointer;
        }

        input[type="range"]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #4ade80;
            cursor: pointer;
            border: none;
        }

        button {
            width: 100%;
            padding: 12px;
            margin-bottom: 10px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #4ade80;
            color: #000;
        }

        .btn-primary:hover {
            background: #22c55e;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: #374151;
            color: #e0e0e0;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .shortcuts {
            font-size: 11px;
            color: #6b7280;
            line-height: 1.6;
        }

        .shortcuts kbd {
            display: inline-block;
            padding: 2px 6px;
            background: #1a1a1a;
            border-radius: 3px;
            font-family: monospace;
            color: #9ca3af;
            border: 1px solid #333;
        }

        .legend {
            margin-top: 15px;
            padding: 12px;
            background: #1a1a1a;
            border-radius: 6px;
            font-size: 12px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .legend-item:last-child {
            margin-bottom: 0;
        }

        .status {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: #4ade80;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <h1>üîç Interactive Overlay</h1>
            
            <div class="section">
                <div class="section-title">Position</div>
                <div class="info-grid">
                    <div class="info-row">
                        <span class="info-label">Offset X:</span>
                        <span class="info-value" id="offset-x">0</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Offset Y:</span>
                        <span class="info-value" id="offset-y">0</span>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-title">Opacity Control</div>
                <div class="control-group">
                    <label class="control-label">
                        Green Layer Opacity: <span id="opacity-value">100%</span>
                    </label>
                    <input type="range" id="opacity-slider" min="0" max="100" value="100">
                </div>
                
                <div class="control-group">
                    <label class="control-label">
                        Green Layer Scale: <span id="scale-value">100%</span>
                    </label>
                    <input type="range" id="scale-slider" min="50" max="150" value="100">
                </div>
                
                <div class="control-group">
                    <label class="control-label">
                        Green Layer Width: <span id="scale-x-value">100%</span>
                    </label>
                    <input type="range" id="scale-x-slider" min="50" max="150" value="100">
                </div>
                
                <div class="control-group">
                    <label class="control-label">
                        Green Layer Height: <span id="scale-y-value">100%</span>
                    </label>
                    <input type="range" id="scale-y-slider" min="50" max="150" value="100">
                </div>
                
                <div class="control-group">
                    <label class="control-label">
                        Green Layer Rotation: <span id="rotation-value">0¬∞</span>
                    </label>
                    <input type="range" id="rotation-slider" min="-180" max="180" value="0">
                </div>
            </div>

            <div class="section">
                <div class="section-title">Actions</div>
                <button class="btn-primary" onclick="saveOverlay()">üíæ Save Overlay</button>
                <button class="btn-secondary" onclick="resetOffset()">‚Ü∫ Reset Position</button>
            </div>

            <div class="section">
                <div class="section-title">Color Legend</div>
                <div class="legend">
                    <div class="legend-item">
                        <span class="color-box" style="background: #ff0000;"></span>
                        <span>Lower image only</span>
                    </div>
                    <div class="legend-item">
                        <span class="color-box" style="background: #00ff00;"></span>
                        <span>Upper image only</span>
                    </div>
                    <div class="legend-item">
                        <span class="color-box" style="background: #0000ff;"></span>
                        <span>Intersection (both images)</span>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-title">Keyboard Shortcuts</div>
                <div class="shortcuts">
                    <div>‚Üë‚Üì‚Üê‚Üí Move 1px</div>
                    <div><kbd>Shift</kbd> + ‚Üë‚Üì‚Üê‚Üí Move 10px</div>
                    <div><kbd>R</kbd> Reset all</div>
                    <div><kbd>S</kbd> Save overlay</div>
                    <div><kbd>+</kbd> / <kbd>-</kbd> Opacity</div>
                    <div><kbd>[</kbd> / <kbd>]</kbd> Scale</div>
                    <div><kbd>W</kbd> / <kbd>Q</kbd> Width</div>
                    <div><kbd>H</kbd> / <kbd>G</kbd> Height</div>
                    <div><kbd>,</kbd> / <kbd>.</kbd> Rotate</div>
                </div>
            </div>
        </div>

        <div class="canvas-container">
            <div class="status" id="status">Offset: (0, 0)</div>
            <canvas id="canvas"></canvas>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        let img = new Image();
        let isDragging = false;
        let startX, startY;
        let currentOffsetX = 0;
        let currentOffsetY = 0;

        // Load initial image
        function updateImage() {
            fetch('/get_image')
                .then(res => res.json())
                .then(data => {
                    img.src = 'data:image/png;base64,' + data.image;
                    currentOffsetX = data.offset_x;
                    currentOffsetY = data.offset_y;
                    updateStatus();
                });
        }

        img.onload = function() {
            // Get container size
            const container = canvas.parentElement;
            const containerWidth = container.clientWidth;
            const containerHeight = container.clientHeight;
            
            // Calculate scale to fit
            const scaleX = containerWidth / img.width;
            const scaleY = containerHeight / img.height;
            const scale = Math.min(scaleX, scaleY, 1); // Don't scale up, only down
            
            // Set canvas to scaled size
            canvas.width = img.width * scale;
            canvas.height = img.height * scale;
            
            // Draw scaled image
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        };

        // Mouse drag handling
        canvas.addEventListener('mousedown', (e) => {
            isDragging = true;
            startX = e.clientX;
            startY = e.clientY;
        });

        canvas.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            
            const dx = e.clientX - startX;
            const dy = e.clientY - startY;
            
            setOffset(currentOffsetX + dx, currentOffsetY + dy)
                .then(() => {
                    startX = e.clientX;
                    startY = e.clientY;
                });
        });

        canvas.addEventListener('mouseup', () => {
            isDragging = false;
        });

        canvas.addEventListener('mouseleave', () => {
            isDragging = false;
        });

        // Keyboard controls
        document.addEventListener('keydown', (e) => {
            let dx = 0, dy = 0;
            const step = e.shiftKey ? 10 : 1;

            switch(e.key) {
                case 'ArrowUp':
                    dy = -step;
                    e.preventDefault();
                    break;
                case 'ArrowDown':
                    dy = step;
                    e.preventDefault();
                    break;
                case 'ArrowLeft':
                    dx = -step;
                    e.preventDefault();
                    break;
                case 'ArrowRight':
                    dx = step;
                    e.preventDefault();
                    break;
                case 'r':
                case 'R':
                    resetOffset();
                    e.preventDefault();
                    break;
                case 's':
                case 'S':
                    saveOverlay();
                    e.preventDefault();
                    break;
                case '+':
                case '=':
                    adjustOpacity(0.1);
                    e.preventDefault();
                    break;
                case '-':
                case '_':
                    adjustOpacity(-0.1);
                    e.preventDefault();
                    break;
                case '[':
                    adjustScale(-0.05);
                    e.preventDefault();
                    break;
                case ']':
                    adjustScale(0.05);
                    e.preventDefault();
                    break;
                case ',':
                case '<':
                    adjustRotation(-1);
                    e.preventDefault();
                    break;
                case '.':
                case '>':
                    adjustRotation(1);
                    e.preventDefault();
                    break;
                case 'w':
                case 'W':
                    adjustScaleX(0.05);
                    e.preventDefault();
                    break;
                case 'q':
                case 'Q':
                    adjustScaleX(-0.05);
                    e.preventDefault();
                    break;
                case 'h':
                case 'H':
                    adjustScaleY(0.05);
                    e.preventDefault();
                    break;
                case 'g':
                case 'G':
                    adjustScaleY(-0.05);
                    e.preventDefault();
                    break;
            }

            if (dx !== 0 || dy !== 0) {
                setOffset(currentOffsetX + dx, currentOffsetY + dy);
            }
        });

        // Opacity slider
        document.getElementById('opacity-slider').addEventListener('input', (e) => {
            const opacity = e.target.value / 100;
            fetch('/set_opacity', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({opacity: opacity})
            }).then(() => {
                document.getElementById('opacity-value').textContent = e.target.value + '%';
                updateImage();
            });
        });
        
        // Scale slider (uniform - updates both width and height)
        document.getElementById('scale-slider').addEventListener('input', (e) => {
            const scale = e.target.value / 100;
            fetch('/set_scale', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({scale: scale})
            }).then(() => {
                document.getElementById('scale-value').textContent = e.target.value + '%';
                document.getElementById('scale-x-value').textContent = e.target.value + '%';
                document.getElementById('scale-y-value').textContent = e.target.value + '%';
                document.getElementById('scale-x-slider').value = e.target.value;
                document.getElementById('scale-y-slider').value = e.target.value;
                updateImage();
            });
        });
        
        // Width scale slider
        document.getElementById('scale-x-slider').addEventListener('input', (e) => {
            const scale_x = e.target.value / 100;
            fetch('/set_scale_x', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({scale_x: scale_x})
            }).then(() => {
                document.getElementById('scale-x-value').textContent = e.target.value + '%';
                updateImage();
            });
        });
        
        // Height scale slider
        document.getElementById('scale-y-slider').addEventListener('input', (e) => {
            const scale_y = e.target.value / 100;
            fetch('/set_scale_y', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({scale_y: scale_y})
            }).then(() => {
                document.getElementById('scale-y-value').textContent = e.target.value + '%';
                updateImage();
            });
        });
        
        // Rotation slider
        document.getElementById('rotation-slider').addEventListener('input', (e) => {
            const rotation = parseFloat(e.target.value);
            fetch('/set_rotation', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({rotation: rotation})
            }).then(() => {
                document.getElementById('rotation-value').textContent = e.target.value + '¬∞';
                updateImage();
            });
        });

        function setOffset(x, y) {
            return fetch('/set_offset', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({offset_x: x, offset_y: y})
            }).then(() => updateImage());
        }

        function resetOffset() {
            fetch('/reset', {method: 'POST'})
                .then(() => {
                    document.getElementById('opacity-slider').value = 100;
                    document.getElementById('opacity-value').textContent = '100%';
                    document.getElementById('scale-slider').value = 100;
                    document.getElementById('scale-value').textContent = '100%';
                    document.getElementById('scale-x-slider').value = 100;
                    document.getElementById('scale-x-value').textContent = '100%';
                    document.getElementById('scale-y-slider').value = 100;
                    document.getElementById('scale-y-value').textContent = '100%';
                    document.getElementById('rotation-slider').value = 0;
                    document.getElementById('rotation-value').textContent = '0¬∞';
                    updateImage();
                });
        }

        function saveOverlay() {
            fetch('/save', {method: 'POST'})
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        alert('‚úì Saved to: ' + data.path);
                    }
                });
        }

        function adjustOpacity(delta) {
            const slider = document.getElementById('opacity-slider');
            let newValue = parseInt(slider.value) + (delta * 100);
            newValue = Math.max(0, Math.min(100, newValue));
            slider.value = newValue;
            slider.dispatchEvent(new Event('input'));
        }
        
        function adjustScale(delta) {
            const slider = document.getElementById('scale-slider');
            let newValue = parseInt(slider.value) + (delta * 100);
            newValue = Math.max(50, Math.min(150, newValue));
            slider.value = newValue;
            slider.dispatchEvent(new Event('input'));
        }
        
        function adjustRotation(delta) {
            const slider = document.getElementById('rotation-slider');
            let newValue = parseFloat(slider.value) + delta;
            newValue = Math.max(-180, Math.min(180, newValue));
            slider.value = newValue;
            slider.dispatchEvent(new Event('input'));
        }
        
        function adjustScaleX(delta) {
            const slider = document.getElementById('scale-x-slider');
            let newValue = parseInt(slider.value) + (delta * 100);
            newValue = Math.max(50, Math.min(150, newValue));
            slider.value = newValue;
            slider.dispatchEvent(new Event('input'));
        }
        
        function adjustScaleY(delta) {
            const slider = document.getElementById('scale-y-slider');
            let newValue = parseInt(slider.value) + (delta * 100);
            newValue = Math.max(50, Math.min(150, newValue));
            slider.value = newValue;
            slider.dispatchEvent(new Event('input'));
        }

        function updateStatus() {
            document.getElementById('offset-x').textContent = currentOffsetX + 'px';
            document.getElementById('offset-y').textContent = currentOffsetY + 'px';
            document.getElementById('status').textContent = 
                `Offset: (${currentOffsetX}, ${currentOffsetY})`;
        }

        // Initial load
        updateImage();
    </script>
</body>
</html>
